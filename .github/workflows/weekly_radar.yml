name: Weekly Academic Radar Scan

on:
  # Run every Monday at 9:00 UTC
  schedule:
    - cron: '0 9 * * 1'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      mode:
        description: 'Execution mode'
        required: false
        default: 'search'
        type: choice
        options:
          - search
          - profile
          - full

# Required for workflow to push changes back to repo
permissions:
  contents: write

jobs:
  run-radar:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history to access cached profile.json
          fetch-depth: 0
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ” Check for cached profile
        id: check-profile
        run: |
          if [ -f "cache/profile.json" ]; then
            echo "profile_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Found cached research profile"
          else
            echo "profile_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No cached profile found - will need to run profiler first"
          fi
      
      - name: âš™ï¸ Determine execution mode
        id: set-mode
        run: |
          if [ "${{ github.event.inputs.mode }}" != "" ]; then
            MODE="${{ github.event.inputs.mode }}"
          elif [ "${{ steps.check-profile.outputs.profile_exists }}" == "false" ]; then
            MODE="full"
          else
            MODE="search"
          fi
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Execution mode: $MODE"
      
      - name: ğŸš€ Run Academic Radar
        env:
          # LLM API Keys (configure in GitHub Secrets)
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          
          # OpenAlex Configuration
          OPENALEX_EMAIL: ${{ secrets.OPENALEX_EMAIL }}
          OPENALEX_API_KEY: ${{ secrets.OPENALEX_API_KEY }}
          
          # SMTP Configuration
          SMTP_HOST: ${{ secrets.SMTP_HOST || 'smtp.gmail.com' }}
          SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          
          # System Configuration
          PROFILE_CACHE_PATH: ./cache/profile.json
          PDF_STORAGE_PATH: ./data/papers
          USER_PAPERS_PATH: ./data/user_papers
          
          # Search & Analysis Parameters
          MAX_PAPERS_TO_ANALYZE: ${{ secrets.MAX_PAPERS_TO_ANALYZE || '5' }}
          SEARCH_DAYS_BACK: ${{ secrets.SEARCH_DAYS_BACK || '30' }}
          MIN_BORROWABILITY_SCORE: ${{ secrets.MIN_BORROWABILITY_SCORE || '0.5' }}
          MAX_RESULTS_PER_QUERY: ${{ secrets.MAX_RESULTS_PER_QUERY || '20' }}
          
          # Deep Search Configuration
          TARGET_NEW_PAPERS: ${{ secrets.TARGET_NEW_PAPERS || '5' }}
          MAX_PAGES_TO_SCAN: ${{ secrets.MAX_PAGES_TO_SCAN || '5' }}
          
          # Paper Tracking
          PAPER_HISTORY_DAYS: ${{ secrets.PAPER_HISTORY_DAYS || '365' }}
          
          # LLM Configuration
          LLM_TEMPERATURE: ${{ secrets.LLM_TEMPERATURE || '0.7' }}
          LLM_MODEL: ${{ secrets.LLM_MODEL || 'deepseek-chat' }}
        
        run: |
          echo "ğŸ¯ Starting Academic Radar in '${{ steps.set-mode.outputs.mode }}' mode"
          python main.py --mode ${{ steps.set-mode.outputs.mode }}
      
      - name: ğŸ’¾ Commit updated cache files
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "Academic Radar Bot"
          
          # Add all cache files
          git add cache/sent_papers.json 2>/dev/null || true
          git add cache/profile.json 2>/dev/null || true
          
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to cache files"
          else
            git commit -m "ğŸ¤– Update cache files [skip ci]"
            git push
            echo "âœ… Cache files updated and committed"
          fi
      
      - name: ğŸ“Š Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: radar-logs
          path: |
            academic_radar.log
            cache/profile.json
          retention-days: 30
      
      - name: ğŸ“¢ Notify on failure
        if: failure()
        run: |
          echo "âŒ Academic Radar failed. Check the logs for details."
          # Optional: Add Slack/Discord notification here
